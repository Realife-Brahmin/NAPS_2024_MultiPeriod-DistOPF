% \documentclass{article}
\documentclass[../../outputs/main.tex]{subfiles}

\usepackage{cite} % default

\usepackage{amsmath,amssymb,amsfonts} % default
\usepackage{cleveref}
% The following formats are used so that when I call \cref{label_1} or \cref{label_1,label_2} or \crefrange{label_1}{label_4}: 
    % 1. I never get eq. or eqs. before my bracketed numbers.
    % 2. The numbers are bracketed.

% For single equation references
\crefformat{equation}{(#2#1#3)}
\Crefformat{equation}{(#2#1#3)}
% For multiple equation references
\crefmultiformat{equation}
{(#2#1#3)} % First reference
{ and (#2#1#3)} % Middle references
{ and (#2#1#3)} % Last reference
{ and (#2#1#3)} % Last reference
% For a range of equation references (e.g., (1)-(3))
\crefrangeformat{equation}{(#3#1#4) to (#5#2#6)}


\usepackage{algorithmic} % default
\usepackage{graphicx} % default

% \usepackage[subpreambles=true]{standalone}
\usepackage{import}

% \usepackage{lipsum} 
\usepackage{textcomp} % default
\usepackage{xcolor} % default
% Any packages or configurations specific to this section
\usepackage{lipsum}

\begin{document}

\section{Problem Formulation}

\subsection{Notations}
In this study, the distribution network is accounted as a tree (connected graph) having $N$ number of buses (indexed with \(i\), \(j\), and \(k\)) and the study is conducted for $T$ time steps (indexed by $t$), each of interval length $\Delta t$. The set of all such buses is $N$, and the sets of all buses with DERs and batteries are $D$ and $B$ respectively, such that $D, B \subseteq N$.
A directed edge in the tree is represented by $(i, j)$ or $ij$ and the set containing all such edges is $\mathcal{L}$. Unless otherwise noted, $(i, j)$ indicates that bus $i$ is the 'upstream' or 'parent' bus of bus $j$, which itself may be considered as the 'downstream' or 'child' bus in relation. Each such line has resistance and reactance of \(r_{ij}\) ohm and \(x_{ij}\) ohm, respectively. Magnitude of the current flowing through the line at time \(t\) is denoted by \(I_{ij}^t\) $\left(l_{ij}^t=\left(I_{ij}^t\right)^2\right)$. The voltage magnitude of bus \(j\) at time \(t\) is given by \(V_j^t\) $\left(v_j^t=\left(V_j^t\right)^2\right)$. Apparent power demand at a node \(j\) at time \(t\) is \(s^t_{L_j}\) (\(=p^t_{L_j}+\textit{j}q^t_{L_j}\)). The uncontrolled active power generation from the DER present at bus \(j\) at time step \(t\) is denoted by \(p^t_{D_j}\) and controlled reactive power dispatch from the DER inverter is \(q^t_{D_j}\). Static capacitance attached to a node $j$ is denoted by $q_{C_j}$. The apparent power flow through line {\(ij\)} at time step \(t\) is \(S_{ij}^t\) (\(=P_{ij}^t+\textit{j}Q_{ij}^t\)). In particular, the real power flowing from the substation into the network is denoted by $P^t_{Subs}$ and the associated cost involved per kW is $C^t$. The battery state of charge (soc) or energy level is \(B_j^t\). Charging and discharging active power from battery inverter (of apparent power capacity $S^{t}_{R_j}$) are denoted by \(P_{c_j}^t\) and \(P_{d_j}^t\), respectively and their associated efficiencies are $\eta_c$ and $\eta_d$ respectively. The total state of charge capacity of the batteries are denoted by $B_{R_j}$, and the Rated battery powers are denoted by $P_{B_{R_j}}$. $soc_{min}$ and $soc_{max}$ are fractional values for denoting safe soc limits of a battery in relation to it rated soc capacity. The reactive power support of the battery inverter is \(q_{B_j}^t\). Rated apparent powers of DERs and Batteries at node $j$ are denoted by $S_{D_{R_j}}$ and $S_{B_{R_j}}$ respectively.

\subsection{Centralized Multi-Period OPF with Batteries}
The OPF problem given in \cref{eq:genCost_withSCD} aims to minimize the cost of power borrowed from the substation for the entire horizon. The incorporation of an additional 'Battery Loss' term ($\alpha > 0$) helps us bypass the usage of binary (integer) constraints for modelling the operation of batteries, which would otherwise make the optimization problem harder to solve. The term still ensures the complementarity of charging and discharging operations for any battery during a particular time period \cite{Nazir2018Jun, Nazir2019Jun, Nazir2021Sep}.

% \begin{equation}
%     \min {\sum_{t = 1}^{T} \left[ C^t P^t_{Subs} + \alpha \sum_{j \in \mathcal{B}} \left\{ (1-\eta_C)P^t_{C_j} + \left( \frac{1}{\eta_D} - 1 \right) P^t_{D_j}\right\} \right] } \label{eq:genCost_withSCD}
% \end{equation}
\begin{equation}
    \begin{split}
        \min \sum_{t = 1}^{T} \left[ C^t P^t_{Subs} + \alpha \sum_{j \in \mathcal{B}} \left\{ (1-\eta_C)P^t_{C_j} \right. \right. \\
        \left. \left. + \left( \frac{1}{\eta_D} - 1 \right) P^t_{D_j} \right\} \right]
    \end{split}
    \label{eq:genCost_withSCD}
\end{equation}


Subject to the constraints \crefrange{eq:RealPowerBalanceNodej}{eq:modelEndsHere-and-lim_Bj} given below:

\begin{align}
    % {p_j^t} & = {\sum_{(j, k) \in \mathcal{L}} P_{jk}^t - \left\{P_{ij}^t - r_{ij}l_{ij}^t\right\} - P_{d_j}^t + P_{c_j}^t} && \label{eq:RealPowerBalanceNodej} \\ 
    % {0} &= {\sum_{(j, k) \in \mathcal{L}} \left\{P_{jk}^t\right\} - \left(P_{ij}^t - r_{ij}l_{ij}^t\right) - \left(P_{d_j}^t - P_{c_j}^t\right) - p^t_{D_j} + p^t_{L_j}} && \label{eq:RealPowerBalanceNodej} \\ 
    % \begin{align}
    {0} &= {\sum_{(j, k) \in \mathcal{L}} \left\{P_{jk}^t\right\} 
        - \left(P_{ij}^t - r_{ij}l_{ij}^t\right)} \nonumber && \\[-0.50em]
    {}  &\qquad \qquad {- \left(P_{d_j}^t - P_{c_j}^t\right) - p^t_{D_j} + p^t_{L_j}}
    \label{eq:RealPowerBalanceNodej} &&
\end{align}

\vspace{-1.5em} % Adjust the space as needed

\begin{align}
% \end{align}
    % \end{align}
    % {q_j^t} & = {\sum_{(j, k) \in \mathcal{L}} Q_{jk}^t - \left\{Q_{ij}^t - x_{ij}l_{ij}^t\right\} - q_{D_j}^t - q_{B_j}^t} && \label{eq:Qij} \\ 
    % {0} &= {\sum_{(j, k) \in \mathcal{L}} \left\{Q_{jk}^t\right\} - \left(Q_{ij}^t - x_{ij}l_{ij}^t\right) - q_{D_j}^t - q_{B_j}^t - q_{C_j} + q^t_{L_j}} && \label{eq:ReactivePowerBalanceNodej} \\ 
    % \begin{align}
    {0} &= {\sum_{(j, k) \in \mathcal{L}} \left\{Q_{jk}^t\right\} 
        - \left(Q_{ij}^t - x_{ij}l_{ij}^t\right)} \nonumber && \\[-0.50em]
    {} &\qquad \qquad { - q_{D_j}^t - q_{B_j}^t - q_{C_j} + q^t_{L_j} } 
    % \label{eq:ReactivePowerBalanceNodej} && \\[0.75em]
    \label{eq:ReactivePowerBalanceNodej} &&
\end{align}
    % \end{align}
    % {p_j^t} &= {p_D{_j}^t - p_L{_j}^t} \label{eq:pj}\\
    % {q_j^t} &= {q_C{_j} -q_L{_j}^t} \label{eq:qj}\\
    % {v_j^t} & = {v_{i}^t +  \left\{r_{ij}^2 + x_{ij}^2\right\}l_{ij}^t - 2(r_{ij}P_{ij}^t + x_{ij}Q_{ij}^t)} \label{eq:vj} && \\
    % {0} &= {v_{i}^t - v_j^t - 2(r_{ij}P_{ij}^t + x_{ij}Q_{ij}^t) + \left\{r_{ij}^2 + x_{ij}^2\right\}l_{ij}^t} \label{eq:KVL-branch-ij} && \\

\vspace{-1.5em} % Adjust the space as needed

\begin{align}
    {0} &= {v_{i}^t - v_j^t - 2(r_{ij}P_{ij}^t + x_{ij}Q_{ij}^t)} \nonumber && \\[-0.00em]
    {} &\qquad \qquad {+ \left\{r_{ij}^2 + x_{ij}^2\right\}l_{ij}^t} \label{eq:KVL-branch-ij} &&
\end{align}

\vspace{-1.5em} % Adjust the space as needed

\begin{align}
    % {l_{ij}^t} & = {\frac{(P_{ij}^{t})^2 + (Q_{ij}^{t})^2}{v_i^t}} \label{eq:lij} && \\
    {0} &= {(P_{ij}^{t})^2 + (Q_{ij}^{t})^2 - l_{ij}^t v_i^t} \label{eq:ApparentPowerEquationBFM} &&
\end{align}

\vspace{-1.5em} % Adjust the space as needed

\begin{align}
    {P^t_{Subs}} &\geq {0} \label{eq:substationRealPowerLimits} &&
\end{align}

\vspace{-1.5em} % Adjust the space as needed

\begin{align}
    { l^{t}_{ij} } &\in { \left[ 0, I^{2}_{R, ij}
    \right] } \label{eq:lim_lij} &&
\end{align}

\vspace{-1.5em} % Adjust the space as needed

\begin{align}
    { v^{t}_{j} } &\in { \left[ V^{2}_{min}, V^{2}_{max} \right]} \label{eq:lim_vj} &&
\end{align}

\vspace{-1.5em} % Adjust the space as needed

\begin{align}
    { q^{t}_{D_{j}} } 
    &\in
    { \left[-\sqrt{ {S_{D_{R, j}}}^2 - {p^{t}_{D_{j}}}^2}, \sqrt{ {S_{D_{R, j}}}^2 - {p^{t}_{D_{j}}}^2}\right] } \label{eq:qDj} &&
\end{align}

\vspace{-1.5em} % Adjust the space as needed

\begin{align}
    {0} &= {  B_{j}^{t} - \left\{B_{j}^{t-1} + \Delta t  \eta_c P_{c_j}^t - \Delta t\frac{1}{\eta_d} P_{d_j}^t \right\} } \label{eq:SOC-j} &&
\end{align}

\vspace{-1.5em} % Adjust the space as needed

\begin{align}
    { P^{t}_{c_{j}}, P^{t}_{d_{j}} }
    &\in
    { \left[ 0, P_{B_{R_{j}}} \right]} \label{eq:lim_PcPdj} &&
\end{align}

\vspace{-1.5em} % Adjust the space as needed

\begin{align}
    % { q^{t}_{B_{j}} } 
    % &\in 
    % { \left[-\sqrt{ {S_{B_{R, j}}}^2 - {P_{B_{R, j}}}^2}, \sqrt{ {S_{B_{R, j}}}^2 - {P_{B_{R, j}}}^2}\right] } \label{eq:qBj} && \\
    { q^{t}_{B_{j}} } 
    &\in 
    { \left[-0.44P_{B_{R, j}}, 0.44P_{B_{R, j}}\right] } \label{eq:qBj} &&
\end{align}

\vspace{-1.5em} % Adjust the space as needed

\begin{align}
    % { B^{t}_{j} } &\in { \left[ soc_{min}B_{R, j}, soc_{max}B_{R, j} \right] } \label{eq:lim_Bj} && \\
    { B^{t}_{j} } &\in { \left[ soc_{min}B_{R, j}, soc_{max}B_{R, j} \right] } \label{eq:modelEndsHere-and-lim_Bj} &&
    % {} & {} \nonumber \label{eq:modelEndsHere-and-lim_Bj}
\end{align}

The distribution network is represented with the help of the branch power flow equations \crefrange{eq:RealPowerBalanceNodej}{eq:ApparentPowerEquationBFM}. Constraints \cref{eq:RealPowerBalanceNodej,eq:ReactivePowerBalanceNodej} signify the active and reactive power balance at node $j$, including contributions from any attached DERs ($p^t_{D_j} , q^t_{D_j}$) and/or batteries ($P^t_{c_j}, P^t_{d_j}, q^t_{B_j}$). 
% The net active and reactive power injections at any bus \(j\) are represented by \cref{eq:pj,eq:qj} respectively. 
The KVL equation for branch $(i, j)$ is represented by \cref{eq:KVL-branch-ij}, while the equation describing the relationship between current magnitude, voltage magnitude and apparent power magnitude for nodes $i$ and $j$ is \cref{eq:ApparentPowerEquationBFM}. Backflow of real power into the substation from the distribution system is avoided using the constraint \cref{eq:substationRealPowerLimits}.The box limits for squared branch current and squared node voltage are enforced via \cref{eq:lim_vj,eq:lim_lij}. \cref{eq:qDj} describes the reactive power limits of DER inverters. The trajectory of the state of charge of batteries versus time is given by \cref{eq:SOC-j} and is the only class of constraints in this paper coupling the optimal power flow problem in time. Battery charging and discharging powers are non-negative valued variables which should not exceed the battery's rated power capacity, as given by \cref{eq:lim_PcPdj}. Every battery's reactive power is also constrained based on the associated inverter's rated capacity, as described by \cref{eq:qBj}. For safe and sustainable operation of the batteries, the state of charge $B^{t}_{j}$ is constrained to be within some percentage limits of the rated battery soc capacity, as given in \cref{eq:modelEndsHere-and-lim_Bj}

% Node $i$ denotes the `parent' node of node $j$, which itself may be the parent of a set of $k$ `children' nodes (the set may contain one, many or even zero nodes, if $j$ is a leaf node). It may be noted that for a radial distribution system, each node $j$ can have only one `parent' node $i$.


\subsection{ENApp based Distributed Multi-Period OPF with Batteries} \label{subsec:ENApp}

Solving a nonlinear nonconvex OPF problem is computationally intensive. In the ENApp paradigm, the original OPF problem is divided into several subproblems, based on physically connected `parent-child' area relationships in the radial distribution network. ENApp primiarly requires three classes of operations. The first is of course solving for the OPF of each individual subproblem, the second is checking for `boundary convergence' between related areas to check if further improvement iterations are needed and the third and last operation is exchange of variables between related areas for subsequent iterations. Out of these three operations, only solving the OPF is computationally intensive. 

The key advantage of using ENApp in preference to MPCOPF is its efficient division of the OPF problem into several smaller problems via efficient exploitation of power flow physics in a radial network \cite{Sadnan}. Typically, Nonlinear Programming problems grow superlinearly in complexity with increase in problem size, and thus division of the OPF problem into smaller, more manageable chunks greatly speeds up the solution process.

The solution process for each subproblem can then be parallelized, saving computation time even further.

Additionally, on paper it might appear that ENApp requires solving of the subproblems across multiple iterations, potentially nullifying the benefit from reduction in problem size. However in practice, once the first OPF iteration is completed for each area, the results can be used to `warm-start' subsequent iterations with significant speedups in solution times.

Thus, in essence, the `computational bottleneck' for ENApp is computing the OPF solution of its biggest subproblem, which typically translates to the single biggest area as part of the spatial decomposition of the radial distribution grid (assuming the number of DERs and Batteries is not significantly higher in another area).

The advantage of this smaller computational bottleneck will be readily seen in \Cref{subsec:simulationResults,subsec:scalabilityAnalysis} when compared against MPCOPF on the Test System. 

For the rest of this paper, we'll be addressing ENAPpp based Distributed Multi-Period OPF simply as MPDOPF for brevity.

\end{document}
